name: Create PWA Tools Release

on:
  push:
    tags:
      - v*

permissions:
  contents: write

jobs:
  release:
    name: Release PWA Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          gh release create "$tag" \
              --repo="$GITHUB_REPOSITORY" \
              --title="PWA Tools $tag" \
              --generate-notes
      
      - name: Create ZIP Archive with Original Folder Structure
        run: |
          # Create a temporary directory for the package
          mkdir -p pwa-tools-package/public
          mkdir -p pwa-tools-package/src/pwa
          
          # Copy files preserving the original structure
          cp public/sw.js pwa-tools-package/public/
          cp public/sw-utils.js pwa-tools-package/public/
          cp public/manifest.webmanifest pwa-tools-package/public/
          cp public/splash.png pwa-tools-package/public/
          
          cp src/pwa/init.ts pwa-tools-package/src/pwa/
          cp src/pwa/pwa-install-prompt.ts pwa-tools-package/src/pwa/
          cp src/pwa/pwa-install-prompt-style.ts pwa-tools-package/src/pwa/
          cp src/pwa/pwa-caching.ts pwa-tools-package/src/pwa/
          
          # Create the ZIP file
          zip -r pwa-tools-package.zip pwa-tools-package
      
      - name: Upload ZIP Package to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          gh release upload "$tag" pwa-tools-package.zip --clobber
      
      - name: Add README to Release Description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          echo "## PWA Tools Package" > release-notes.md
          echo "" >> release-notes.md
          echo "This release contains a single ZIP file \`pwa-tools-package.zip\` with the following structure:" >> release-notes.md
          echo "" >> release-notes.md
          echo "### Files Included" >> release-notes.md
          echo "```" >> release-notes.md
          echo "pwa-tools-package/" >> release-notes.md
          echo "├── public/" >> release-notes.md
          echo "│   ├── sw.js - Main service worker file" >> release-notes.md
          echo "│   ├── sw-utils.js - Service worker utility functions" >> release-notes.md
          echo "│   ├── manifest.webmanifest - Web app manifest file" >> release-notes.md
          echo "│   └── splash.png - Default splash screen image" >> release-notes.md
          echo "└── src/" >> release-notes.md
          echo "    └── pwa/" >> release-notes.md
          echo "        ├── init.ts - Service worker registration" >> release-notes.md
          echo "        ├── pwa-install-prompt.ts - Install prompt logic" >> release-notes.md
          echo "        ├── pwa-install-prompt-style.ts - Install prompt styling" >> release-notes.md
          echo "        └── pwa-caching.ts - Caching strategies" >> release-notes.md
          echo "```" >> release-notes.md
          echo "" >> release-notes.md
          echo "See the README.md file for installation and usage instructions." >> release-notes.md
          gh release edit "$tag" --notes-file release-notes.md

